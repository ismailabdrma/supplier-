<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier System Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .product-card { transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); }
        .stock-badge { position: absolute; top: 10px; right: 10px; }
        .price-display { font-size: 1.2em; font-weight: bold; color: #28a745; }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="#">
            <i class="fas fa-store"></i> Supplier System
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="#" onclick="showSection('products')">Products</a>
            <a class="nav-link" href="#" onclick="showSection('add-product')">Add Product</a>
            <a class="nav-link" href="#" onclick="showSection('payments')">Payments</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Products Section -->
    <div id="products-section" class="section" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-box"></i> Product Catalog</h2>
            <button class="btn btn-primary" onclick="loadProducts()">
                <i class="fas fa-refresh"></i> Refresh
            </button>
        </div>
        <div id="products-container" class="row"></div>
    </div>

    <!-- Add Product Section -->
    <div id="add-product-section" class="section">
        <h2><i class="fas fa-plus"></i> Add New Product</h2>
        <div class="card">
            <div class="card-body">
                <form id="add-product-form" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productname" class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="productname" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="price" class="form-label">Price ($) *</label>
                                <input type="number" class="form-control" id="price" name="price" step="0.01" min="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="description" class="form-label">Description *</label>
                                <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="productImage" class="form-label">Product Image (.png/.jpg) *</label>
                                <input type="file" class="form-control" id="productImage" name="productImage" accept="image/png, image/jpeg" required>
                                <div class="form-text">Max file size: 5MB</div>
                            </div>
                            <div class="mb-3">
                                <label for="availableQuantity" class="form-label">Available Quantity *</label>
                                <input type="number" class="form-control" id="availableQuantity" name="availableQuantity" min="1" required>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100" id="addProductBtn">
                        <i class="fas fa-save"></i> Add Product
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Payments Section -->
    <div id="payments-section" class="section" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-credit-card"></i> Payment History</h2>
            <button class="btn btn-primary" onclick="loadPayments()">
                <i class="fas fa-refresh"></i> Refresh
            </button>
        </div>
        <div id="payments-container"></div>
    </div>
</div>

<!-- Stock Update Modal -->
<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stock-form">
                    <input type="hidden" id="stockProductId">
                    <div class="mb-3">
                        <label for="newQuantity" class="form-label">New Quantity</label>
                        <input type="number" class="form-control" id="newQuantity" required min="0">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateStock()">Update Stock</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_BASE = "/api";
    const bootstrap = window.bootstrap;

    document.addEventListener("DOMContentLoaded", () => {
        // Show "Add Product" by default
        showSection('add-product');
        loadProducts();

        // Bind form event only if form exists
        const form = document.getElementById("add-product-form");
        if (form) {
            form.addEventListener("submit", (e) => {
                e.preventDefault();
                addProduct();
            });
        }
    });

    function showSection(sectionName) {
        document.querySelectorAll(".section").forEach((section) => {
            section.style.display = "none";
        });
        document.getElementById(sectionName + "-section").style.display = "block";
        if (sectionName === "products") loadProducts();
        else if (sectionName === "payments") loadPayments();
    }

    function showLoading(show) {
        const overlay = document.getElementById("loadingOverlay");
        overlay.style.display = show ? "flex" : "none";
    }

    function loadProducts() {
        showLoading(true);
        fetch(`${API_BASE}/products`)
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then((products) => displayProducts(products))
            .catch((error) => {
                console.error("Error loading products:", error);
                showAlert("Error loading products: " + error.message, "danger");
            })
            .finally(() => showLoading(false));
    }

    function displayProducts(products) {
        const container = document.getElementById("products-container");
        if (!products || products.length === 0) {
            container.innerHTML = '<div class="col-12"><div class="alert alert-info">No products found.</div></div>';
            return;
        }

        container.innerHTML = products.map(product => {
            const imageUrl = product.pictureUrl
                ? (product.pictureUrl.startsWith('/')
                    ? product.pictureUrl
                    : '/uploads/' + product.pictureUrl)
                : null;

            return `
    <div class="col-md-4 mb-4">
      <div class="card product-card h-100 position-relative">
        <span class="badge bg-${product.availableQuantity > 0 ? "success" : "danger"} stock-badge">
          Stock: ${product.availableQuantity}
        </span>
        ${imageUrl ? `
          <img src="${imageUrl}"
               class="card-img-top"
               alt="${product.name}"
               style="height: 200px; object-fit: cover;"
               onerror="this.onerror=null; this.src='https://via.placeholder.com/300?text=Image+Not+Found'">
        ` : `
          <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
            <i class="fas fa-image text-muted" style="font-size: 3rem;"></i>
          </div>
        `}
        <div class="card-body">
          <h5 class="card-title">${product.name}</h5>
          <p class="card-text">${product.description}</p>
          <div class="price-display mb-3">$${product.price.toFixed(2)}</div>
        </div>
        <div class="card-footer">
          <div class="btn-group w-100" role="group">
            <button class="btn btn-outline-primary btn-sm" onclick="openStockModal(${product.id}, ${product.availableQuantity})">
              <i class="fas fa-edit"></i> Update Stock
            </button>
            <button class="btn btn-success btn-sm" onclick="buyProduct(${product.id})" ${product.availableQuantity === 0 ? "disabled" : ""}>
              <i class="fas fa-shopping-cart"></i> Buy Now
            </button>
          </div>
        </div>
      </div>
    </div>
    `;
        }).join("");
    }

    function addProduct() {
        // Get form values
        const name = document.getElementById("productname").value;
        const description = document.getElementById('description').value;
        const price = document.getElementById('price').value;
        const availableQuantity = document.getElementById('availableQuantity').value;
        const imageInput = document.getElementById('productImage');

        // Validate inputs
        if (!name || !description || !price || !availableQuantity) {
            showAlert("Please fill all required fields", "danger");
            return;
        }

        if (parseFloat(price) <= 0) {
            showAlert("Price must be greater than zero", "danger");
            return;
        }

        if (parseInt(availableQuantity) < 0) {
            showAlert("Quantity cannot be negative", "danger");
            return;
        }

        if (imageInput.files.length === 0) {
            showAlert("Please select a product image", "danger");
            return;
        }

        // Create form data
        const formData = new FormData();
        formData.append('name', name);
        formData.append('description', description);
        formData.append('price', price);
        formData.append('availableQuantity', availableQuantity);
        formData.append('productImage', imageInput.files[0]);

        // Disable button during submission
        const addButton = document.getElementById("addProductBtn");
        addButton.disabled = true;
        addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

        showLoading(true);

        // Send request
        fetch(`${API_BASE}/products/upload`, {
            method: "POST",
            body: formData,
        })
            .then((response) => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.json().then(error => {
                        throw new Error(error.error || "Failed to add product")
                    });
                }
            })
            .then((createdProduct) => {
                showAlert("Product added successfully!", "success");
                document.getElementById("add-product-form").reset();
                loadProducts();
            })
            .catch((error) => {
                console.error("Error adding product:", error);
                showAlert("Error adding product: " + error.message, "danger");
            })
            .finally(() => {
                showLoading(false);
                addButton.disabled = false;
                addButton.innerHTML = '<i class="fas fa-save"></i> Add Product';
            });
    }

    function openStockModal(productId, currentQuantity) {
        document.getElementById("stockProductId").value = productId;
        document.getElementById("newQuantity").value = currentQuantity;
        new bootstrap.Modal(document.getElementById("stockModal")).show();
    }

    function updateStock() {
        const productId = document.getElementById("stockProductId").value;
        const newQuantity = Number.parseInt(document.getElementById("newQuantity").value);

        if (newQuantity < 0) {
            showAlert("Quantity cannot be negative", "danger");
            return;
        }

        showLoading(true);

        fetch(`${API_BASE}/products/stock/${productId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ quantity: newQuantity }),
        })
            .then((response) => {
                if (response.ok) {
                    showAlert("Stock updated successfully!", "success");
                    bootstrap.Modal.getInstance(document.getElementById("stockModal")).hide();
                    loadProducts();
                } else {
                    throw new Error("Failed to update stock");
                }
            })
            .catch((error) => {
                console.error("Error updating stock:", error);
                showAlert("Error updating stock: " + error.message, "danger");
            })
            .finally(() => showLoading(false));
    }

    function buyProduct(productId) {
        const quantity = prompt("Enter quantity to purchase:", "1");
        if (!quantity || quantity <= 0) return;

        showLoading(true);

        fetch(`${API_BASE}/payments/create-checkout-session`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productId: productId, quantity: Number.parseInt(quantity) }),
        })
            .then((response) => {
                if (response.ok) return response.json();
                throw new Error("Failed to create checkout session");
            })
            .then((data) => {
                if (data.url) window.location.href = data.url;
                else throw new Error(data.error || "Failed to create checkout session");
            })
            .catch((error) => {
                console.error("Error creating checkout session:", error);
                showAlert("Error: " + error.message, "danger");
            })
            .finally(() => showLoading(false));
    }

    function loadPayments() {
        showLoading(true);
        fetch(`${API_BASE}/payments`)
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then((payments) => displayPayments(payments))
            .catch((error) => {
                console.error("Error loading payments:", error);
                showAlert("Error loading payments: " + error.message, "danger");
            })
            .finally(() => showLoading(false));
    }

    function displayPayments(payments) {
        const container = document.getElementById("payments-container");
        if (!payments || payments.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No payments found.</div>';
            return;
        }
        container.innerHTML = `
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Product ID</th>
            <th>Amount</th>
            <th>Quantity</th>
            <th>Status</th>
            <th>Date</th>
            <th>Stripe Session</th>
          </tr>
        </thead>
        <tbody>
          ${payments.map(payment => `
            <tr>
              <td>${payment.id}</td>
              <td>${payment.productId}</td>
              <td>$${payment.amount.toFixed(2)}</td>
              <td>${payment.quantity || 1}</td>
              <td>
                <span class="badge bg-${getStatusColor(payment.status)}">${payment.status}</span>
              </td>
              <td>${new Date(payment.timestamp).toLocaleString()}</td>
              <td><small class="text-muted">${payment.stripeSessionId || "N/A"}</small></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;
    }

    function getStatusColor(status) {
        switch (status) {
            case "SUCCESS": return "success";
            case "PENDING": return "warning";
            case "FAILED": return "danger";
            default: return "secondary";
        }
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = "1060";
        alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(alertDiv);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>
</body>
</html>